#!/usr/bin/env bash

set -euo pipefail

DRY_RUN="0"

if [[ -z "${XDG_CONFIG_HOME:-}" ]]; then
  echo "XDG_CONFIG_HOME not defined, using ~/.config"
  XDG_CONFIG_HOME="$HOME/.config"
fi

if [[ -z "${DEV_ENV:-}" ]]; then
  echo "DEV_ENV needs to be set" >&2
  exit 1
fi

source "$DEV_ENV/utils/common.sh"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry|--dry-run)
      DRY_RUN="1"
      ;;
    --help|-h)
      echo "Usage: dev-env [OPTIONS]"
      echo ""
      echo "Deploy dev environment configs to system"
      echo ""
      echo "Options:"
      echo "  --dry, --dry-run  Show what would be done without making changes"
      echo "  --help, -h        Show this help message"
      echo ""
      echo "Environment:"
      echo "  DEV_ENV           Required. Path to dev environment repo"
      echo "  XDG_CONFIG_HOME   Optional. Defaults to ~/.config"
      echo "  BACKUP_DIR        Optional. Defaults to ~/.config-backups"
      exit 0
      ;;
    *)
      log_error "Unknown option: $1"
      exit 1
      ;;
  esac
  shift
done

export DRY_RUN

log_info "env: $DEV_ENV"

require_dir "$DEV_ENV/env"
require_disk_space 50
init_backup_session "dev-env-$(date +%Y%m%d-%H%M%S)"

update_files() {
  local src="$1" dest="$2"

  require_dir "$src"
  require_writable "$dest"

  log_info "Copying files from: $src"
  pushd "$src" >/dev/null

  local configs
  configs=$(find . -mindepth 1 -maxdepth 1 -type d)
  for c in $configs; do
    local directory="${dest%/}/${c#./}"
    log_debug "  Processing: $directory"

    safe_remove "$directory"

    if [[ "$DRY_RUN" == "0" ]]; then
      cp -r "./$c" "$dest" || error_exit "Copy failed for $c"
    else
      log_dry "  Would copy: $c -> $dest"
    fi
  done

  popd >/dev/null
}

copy() {
  local src="$1" dest="$2"

  require_file "$src"

  local dest_parent
  dest_parent="$(dirname "$dest")"
  require_writable "$dest_parent"

  safe_copy "$src" "$dest"
}

if [[ "$DRY_RUN" == "0" ]] && command -v hyprctl >/dev/null 2>&1; then
  hyprctl keyword misc:disable_autoreload true 2>/dev/null || true
fi

update_files "$DEV_ENV/env/.config" "$XDG_CONFIG_HOME"
update_files "$DEV_ENV/env/.local" "$HOME/.local"

copy "$DEV_ENV/env/.aliases" "$HOME/.aliases"
copy "$DEV_ENV/env/.zprofile" "$HOME/.zprofile"
copy "$DEV_ENV/env/.zshenv" "$HOME/.zshenv"
copy "$DEV_ENV/env/.zshrc" "$HOME/.zshrc"
copy "$DEV_ENV/env/.config/git/config" "$HOME/.config/git/config"
copy "$DEV_ENV/env/.config/starship.toml" "$XDG_CONFIG_HOME/starship.toml"

if [[ "$DRY_RUN" == "0" ]] && command -v hyprctl >/dev/null 2>&1; then
  hyprctl reload >/dev/null 2>&1 || log_warn "hyprctl reload failed"
  hyprctl keyword misc:disable_autoreload false 2>/dev/null || true
fi

cleanup_old_backups 5

log_success "Dev environment deployed successfully"
if [[ -n "${_BACKUP_SESSION_DIR:-}" ]]; then
  log_info "Backup saved to: $_BACKUP_SESSION_DIR"
fi
