#!/usr/bin/env bash

set -euo pipefail

# Helper function to fetch a secret from Bitwarden and store it
fetch_secret() {
    local item_id="$1"
    local field_name="$2"
    local dest_file="$3"

    [[ -n "${item_id:-}" ]] || {
        echo "Error: Bitwarden item ID not provided" >&2
        return 1
    }

    echo "Fetching secret: $dest_file"
    bw get item "$item_id" | jq -r --arg field "$field_name" '.fields[] | select(.name==$field) | .value' > "$dest_file"
    chmod 600 "$dest_file"
}

# Create secrets directory
mkdir -p "$HOME/.secrets"
chmod 700 "$HOME/.secrets"

# Fetch secrets
[[ -n "${BW_GH_MCP_TOKEN_ID:-}" ]] || { echo "Error: BW_GH_MCP_TOKEN_ID not set" >&2; exit 1; }
fetch_secret "$BW_GH_MCP_TOKEN_ID" "Token" "$HOME/.secrets/gh_mcp_token"

echo "Secrets retrieved successfully"
